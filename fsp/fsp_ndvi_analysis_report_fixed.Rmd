---
title: "FSP NDVI Analysis Report"
subtitle: "Spectral Analysis for 2019-2024"
author: "NEON FSP Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    highlight: tango
    code_folding: hide
    fig_width: 10
    fig_height: 6
    fig_caption: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)

# Load required packages
library(neonUtilities)
library(dplyr)
library(tidyr)
library(ggplot2)
library(DT)
library(knitr)
library(kableExtra)
library(scales)
```

## Executive Summary

This report presents a comprehensive analysis of NDVI (Normalized Difference Vegetation Index) calculations from NEON FSP (Field Spectral) data collected between 2019-2024. The analysis includes:

- **NDVI calculations** using red (670 nm) and NIR (800 nm) reflectance bands
- **Spectral quality assessment** of downloaded CSV files
- **Temporal and spatial patterns** across NEON sites
- **Data quality assessment** and error analysis

## Data Processing

```{r data_processing, echo=FALSE, results='hide'}
# Set date range
startDate_checked <- "2019-01"
endDate_checked <- "2024-12"

# Load FSP data with error handling
cat("Loading FSP data for date range:", startDate_checked, "to", endDate_checked, "\n")

fsp_data_loaded <- FALSE
tryCatch({
  fsp_data <- neonUtilities::loadByProduct(
    dpID = "DP1.30012.001", 
    site = "all", 
    startdate = startDate_checked, 
    enddate = endDate_checked,
    package = "expanded",
    check.size = FALSE,
    token = Sys.getenv('NEON_PAT')
  )
  
  # Extract tables
  fsp_spectralData <- fsp_data$fsp_spectralData
  fsp_sampleMetadata <- fsp_data$fsp_sampleMetadata
  fsp_boutMetadata <- fsp_data$fsp_boutMetadata
  
  fsp_data_loaded <- TRUE
  cat("Successfully loaded FSP data\n")
}, error = function(e) {
  cat("Error loading NEON data:", e$message, "\n")
  cat("Trying with a single site (HARV) for 2023 as fallback...\n")
  
  tryCatch({
    fsp_data <- neonUtilities::loadByProduct(
      dpID = "DP1.30012.001", 
      site = "HARV", 
      startdate = "2023-01", 
      enddate = "2023-12",
      package = "expanded",
      check.size = FALSE
    )
    
    fsp_spectralData <- fsp_data$fsp_spectralData
    fsp_sampleMetadata <- fsp_data$fsp_sampleMetadata
    fsp_boutMetadata <- fsp_data$fsp_boutMetadata
    
    fsp_data_loaded <- TRUE
    cat("Successfully loaded fallback data from HARV\n")
  }, error = function(e2) {
    cat("Fallback also failed:", e2$message, "\n")
    fsp_spectralData <- data.frame()
    fsp_sampleMetadata <- data.frame()
    fsp_boutMetadata <- data.frame()
  })
})
```

## Data Loading Status

```{r data_status, echo=FALSE}
# Check data loading status
if(fsp_data_loaded && exists("fsp_spectralData") && nrow(fsp_spectralData) > 0) {
  cat("**Data Loading Status:** SUCCESS\n\n")
  cat("### Data Summary:\n")
  cat("- FSP spectral records:", nrow(fsp_spectralData), "\n")
  cat("- FSP sample metadata records:", nrow(fsp_sampleMetadata), "\n")
  cat("- FSP bout metadata records:", nrow(fsp_boutMetadata), "\n")
  
  if("collectDate" %in% names(fsp_sampleMetadata)) {
    date_range <- range(fsp_sampleMetadata$collectDate, na.rm = TRUE)
    cat("- Date range:", date_range[1], "to", date_range[2], "\n")
  }
  
  if("siteID" %in% names(fsp_sampleMetadata)) {
    cat("- Number of sites:", length(unique(fsp_sampleMetadata$siteID)), "\n")
    cat("- Sites:", paste(unique(fsp_sampleMetadata$siteID), collapse = ", "), "\n")
  }
} else {
  cat("**Data Loading Status:** FAILED\n\n")
  cat("### Troubleshooting:\n")
  cat("- Check your internet connection\n")
  cat("- Verify NEON_PAT token is set if using one\n")
  cat("- Try a more recent date range (e.g., 2023-2024)\n")
  cat("- Try a specific site instead of 'all'\n")
}
```

## NDVI Processing

```{r ndvi_processing, echo=FALSE}
# Initialize results
ndvi_results <- data.frame()
download_errors <- data.frame()

if(fsp_data_loaded && nrow(fsp_spectralData) > 0) {
  cat("\n### Processing spectral data files...\n")
  
  # Get unique spectral samples with download URLs
  spectral_samples <- fsp_spectralData %>%
    filter(!is.na(downloadFileUrl)) %>%
    select(spectralSampleID, downloadFileUrl) %>%
    distinct()
  
  # Join with sample metadata to get site and date info
  samples_to_process <- spectral_samples %>%
    left_join(fsp_sampleMetadata %>% 
              select(spectralSampleID, siteID, collectDate, eventID) %>%
              distinct(), 
              by = "spectralSampleID")
  
  cat("Found", nrow(samples_to_process), "spectral samples to process\n")
  
  # Process all samples
  for(i in 1:nrow(samples_to_process)) {
    sample <- samples_to_process[i,]
    
    tryCatch({
      # Download CSV file
      temp_file <- tempfile(fileext = ".csv")
      download.file(sample$downloadFileUrl, temp_file, quiet = TRUE, mode = "wb")
      
      # Read spectral data
      csv_data <- read.csv(temp_file, stringsAsFactors = FALSE)
      
      # Check if wavelength and reflectance columns exist
      if(all(c("wavelength", "reflectance") %in% names(csv_data))) {
        # Extract red band (around 670 nm)
        red_data <- csv_data %>%
          filter(wavelength >= 660 & wavelength <= 680) %>%
          summarise(red_reflectance = mean(reflectance, na.rm = TRUE))
        
        # Extract NIR band (around 800 nm)
        nir_data <- csv_data %>%
          filter(wavelength >= 790 & wavelength <= 810) %>%
          summarise(nir_reflectance = mean(reflectance, na.rm = TRUE))
        
        # Calculate NDVI
        if(!is.na(red_data$red_reflectance) && !is.na(nir_data$nir_reflectance)) {
          ndvi <- (nir_data$nir_reflectance - red_data$red_reflectance) / 
                  (nir_data$nir_reflectance + red_data$red_reflectance)
          
          # Extract spectral ratio bands
          lower_data <- csv_data %>%
            filter(wavelength >= 495 & wavelength <= 505) %>%
            summarise(lower_reflectance = mean(reflectance, na.rm = TRUE))
          
          higher_data <- csv_data %>%
            filter(wavelength >= 995 & wavelength <= 1005) %>%
            summarise(higher_reflectance = mean(reflectance, na.rm = TRUE))
          
          # Add to results
          ndvi_results <- rbind(ndvi_results, data.frame(
            spectralSampleID = sample$spectralSampleID,
            siteID = sample$siteID,
            collectDate = sample$collectDate,
            eventID = sample$eventID,
            red_reflectance = red_data$red_reflectance,
            nir_reflectance = nir_data$nir_reflectance,
            ndvi = ndvi,
            lower_reflectance = lower_data$lower_reflectance,
            higher_reflectance = higher_data$higher_reflectance,
            spectral_ratio = ifelse(!is.na(higher_data$higher_reflectance) && !is.na(lower_data$lower_reflectance),
                                   higher_data$higher_reflectance / lower_data$lower_reflectance, NA),
            n_wavelengths = nrow(csv_data),
            min_wavelength = min(csv_data$wavelength, na.rm = TRUE),
            max_wavelength = max(csv_data$wavelength, na.rm = TRUE),
            processing_status = "SUCCESS"
          ))
        }
      }
      
      # Clean up
      unlink(temp_file)
      
    }, error = function(e) {
      download_errors <- rbind(download_errors, data.frame(
        spectralSampleID = sample$spectralSampleID,
        error = as.character(e$message)
      ))
    })
  }
  
  cat("\nProcessing complete.\n")
  cat("- Successfully processed:", nrow(ndvi_results), "samples\n")
  cat("- Download errors:", nrow(download_errors), "samples\n")
}
```

## Results Summary

```{r results_summary, echo=FALSE}
if(nrow(ndvi_results) > 0) {
  # Overall NDVI validation (checking if all values are within -1 and 1)
  cat("### NDVI Validation (All Samples)\n")
  ndvi_validation <- ndvi_results %>%
    summarise(
      total_samples = n(),
      within_range = sum(ndvi >= -1 & ndvi <= 1, na.rm = TRUE),
      outside_range = sum(ndvi < -1 | ndvi > 1, na.rm = TRUE),
      percentage_within = round(sum(ndvi >= -1 & ndvi <= 1, na.rm = TRUE) / n() * 100, 1),
      min_ndvi = min(ndvi, na.rm = TRUE),
      max_ndvi = max(ndvi, na.rm = TRUE)
    )
  
  kable(ndvi_validation, digits = 4) %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
  
  # NDVI by Site
  cat("\n### NDVI Statistics by Site\n")
  ndvi_by_site <- ndvi_results %>%
    group_by(siteID) %>%
    summarise(
      n_samples = n(),
      mean_ndvi = mean(ndvi, na.rm = TRUE),
      median_ndvi = median(ndvi, na.rm = TRUE),
      min_ndvi = min(ndvi, na.rm = TRUE),
      max_ndvi = max(ndvi, na.rm = TRUE),
      sd_ndvi = sd(ndvi, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(desc(mean_ndvi))
  
  kable(ndvi_by_site, digits = 4) %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
  
  # Spectral Ratio by Site
  if("spectral_ratio" %in% names(ndvi_results)) {
    cat("\n### Spectral Ratio Statistics by Site\n")
    spectral_ratio_by_site <- ndvi_results %>%
      filter(!is.na(spectral_ratio)) %>%
      group_by(siteID) %>%
      summarise(
        n_samples = n(),
        mean_ratio = mean(spectral_ratio, na.rm = TRUE),
        median_ratio = median(spectral_ratio, na.rm = TRUE),
        min_ratio = min(spectral_ratio, na.rm = TRUE),
        max_ratio = max(spectral_ratio, na.rm = TRUE),
        sd_ratio = sd(spectral_ratio, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      arrange(desc(mean_ratio))
    
    kable(spectral_ratio_by_site, digits = 4) %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
  }
  
} else {
  cat("No NDVI results available. Please check:\n")
  cat("- Data loading status above\n")
  cat("- Internet connectivity for downloading spectral CSV files\n")
  cat("- Date range contains data with spectral measurements\n")
}
```

## Visualizations

```{r visualizations, echo=FALSE, fig.height=8}
if(nrow(ndvi_results) > 0) {
  # Histogram of all NDVI values
  p1 <- ggplot(ndvi_results, aes(x = ndvi)) +
    geom_histogram(bins = 50, fill = "forestgreen", alpha = 0.7) +
    geom_vline(xintercept = c(-1, 1), color = "red", linetype = "dashed", size = 1) +
    labs(title = "Distribution of All NDVI Values",
         x = "NDVI",
         y = "Count") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
  
  print(p1)
  
  # Histogram of all spectral ratios
  if("spectral_ratio" %in% names(ndvi_results)) {
    p2 <- ggplot(ndvi_results %>% filter(!is.na(spectral_ratio)), aes(x = spectral_ratio)) +
      geom_histogram(bins = 50, fill = "orange", alpha = 0.7) +
      geom_vline(xintercept = 1, color = "red", linetype = "dashed", size = 1) +
      labs(title = "Distribution of All Spectral Ratios (995-1005 nm / 495-505 nm)",
           x = "Spectral Ratio", 
           y = "Count") +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
    
    print(p2)
  }
  
  # NDVI distribution by site
  if(length(unique(ndvi_results$siteID)) > 1) {
    p3 <- ggplot(ndvi_results, aes(x = reorder(siteID, ndvi, median), y = ndvi)) +
      geom_boxplot(fill = "lightgreen", alpha = 0.7) +
      coord_flip() +
      labs(title = "NDVI Distribution by Site",
           x = "Site ID",
           y = "NDVI") +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
    
    print(p3)
  }
  
  # Spectral ratio distribution by site
  if("spectral_ratio" %in% names(ndvi_results) && length(unique(ndvi_results$siteID)) > 1) {
    p4 <- ggplot(ndvi_results %>% filter(!is.na(spectral_ratio)), 
                 aes(x = reorder(siteID, spectral_ratio, FUN = median), y = spectral_ratio)) +
      geom_boxplot(fill = "lightcoral", alpha = 0.7) +
      geom_hline(yintercept = 1, color = "red", linetype = "dashed", size = 1) +
      coord_flip() +
      labs(title = "Spectral Ratio Distribution by Site",
           x = "Site ID", 
           y = "Spectral Ratio (995-1005/495-505)") +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
    
    print(p4)
  }
}
```

## Data Quality Assessment

```{r quality_assessment, echo=FALSE}
if(nrow(ndvi_results) > 0) {
  # Check spectral quality
  quality_summary <- ndvi_results %>%
    mutate(
      ndvi_valid = ndvi >= -1 & ndvi <= 1,
      red_valid = red_reflectance >= 0 & red_reflectance <= 1,
      nir_valid = nir_reflectance >= 0 & nir_reflectance <= 1,
      wavelength_range_valid = (max_wavelength - min_wavelength) > 2000
    ) %>%
    summarise(
      total_samples = n(),
      ndvi_valid_pct = mean(ndvi_valid, na.rm = TRUE) * 100,
      red_valid_pct = mean(red_valid, na.rm = TRUE) * 100,
      nir_valid_pct = mean(nir_valid, na.rm = TRUE) * 100,
      wavelength_range_valid_pct = mean(wavelength_range_valid, na.rm = TRUE) * 100
    )
  
  cat("### Quality Metrics\n")
  kable(quality_summary, digits = 1, 
        col.names = c("Total Samples", "Valid NDVI %", "Valid Red %", "Valid NIR %", "Valid Wavelength Range %")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
  
  # Spectral ratio validation
  if("spectral_ratio" %in% names(ndvi_results)) {
    ratio_summary <- ndvi_results %>%
      filter(!is.na(spectral_ratio)) %>%
      summarise(
        n_ratios = n(),
        mean_ratio = mean(spectral_ratio, na.rm = TRUE),
        ratios_above_1 = sum(spectral_ratio > 1, na.rm = TRUE),
        pct_above_1 = mean(spectral_ratio > 1, na.rm = TRUE) * 100
      )
    
    cat("\n### Spectral Ratio Validation (995-1005nm / 495-505nm)\n")
    kable(ratio_summary, digits = 2,
          col.names = c("Samples with Ratio", "Mean Ratio", "Ratios > 1", "% Above 1")) %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
  }
}
```

## Detailed Results Table

```{r detailed_results, echo=FALSE}
if(nrow(ndvi_results) > 0) {
  # Select key columns for display
  display_results <- ndvi_results %>%
    select(spectralSampleID, siteID, collectDate, ndvi, red_reflectance, 
           nir_reflectance, spectral_ratio, n_wavelengths) %>%
    arrange(desc(ndvi))
  
  DT::datatable(display_results,
                options = list(pageLength = 10, scrollX = TRUE),
                caption = "Detailed NDVI Results (sorted by NDVI descending)") %>%
    formatRound(columns = c("ndvi", "red_reflectance", "nir_reflectance", "spectral_ratio"), 
                digits = 3)
}
```

## Interactive Data Table

```{r interactive_table, echo=FALSE}
if(nrow(ndvi_results) > 0) {
  # Create interactive table with key columns
  ndvi_display <- ndvi_results %>%
    select(spectralSampleID, siteID, collectDate, ndvi, spectral_ratio) %>%
    mutate(collectDate = as.Date(collectDate))
  
  datatable(ndvi_display,
            caption = "Interactive NDVI Results Table",
            options = list(
              pageLength = 25,
              scrollX = TRUE,
              dom = 'Bfrtip',
              buttons = c('copy', 'csv', 'excel')
            ),
            rownames = FALSE) %>%
    formatRound(columns = c("ndvi", "spectral_ratio"), digits = 4) %>%
    formatDate(columns = "collectDate", method = "toLocaleDateString")
}
```

## NLCD-Based Analysis

```{r nlcd_analysis, echo=FALSE}
if(nrow(ndvi_results) > 0 && exists("fsp_sampleMetadata")) {
  # Join with sample metadata to get NLCD information
  ndvi_with_nlcd <- ndvi_results %>%
    left_join(fsp_sampleMetadata %>% select(spectralSampleID, nlcdClass),
              by = "spectralSampleID")
  
  if("nlcdClass" %in% names(ndvi_with_nlcd) && sum(!is.na(ndvi_with_nlcd$nlcdClass)) > 0) {
    # NDVI by Site and NLCD Class
    cat("### NDVI Statistics by Site and NLCD Class\n")
    
    ndvi_by_site_nlcd <- ndvi_with_nlcd %>%
      filter(!is.na(nlcdClass)) %>%
      group_by(siteID, nlcdClass) %>%
      summarise(
        n_samples = n(),
        mean_ndvi = mean(ndvi, na.rm = TRUE),
        median_ndvi = median(ndvi, na.rm = TRUE),
        min_ndvi = min(ndvi, na.rm = TRUE),
        max_ndvi = max(ndvi, na.rm = TRUE),
        sd_ndvi = sd(ndvi, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      arrange(siteID, desc(n_samples))
    
    kable(ndvi_by_site_nlcd, 
          col.names = c("Site ID", "NLCD Class", "N Samples", "Mean NDVI", "Median NDVI", "Min NDVI", "Max NDVI", "SD NDVI"),
          caption = "NDVI Statistics by Site and NLCD Land Cover Class",
          digits = 4) %>%
      kable_styling(bootstrap_options = c("striped", "hover"), 
                    full_width = TRUE,
                    position = "left") %>%
      row_spec(0, bold = TRUE, color = "white", background = "#2E8B57") %>%
      scroll_box(width = "100%", height = "600px")
    
    # Spectral Ratio by Site and NLCD Class
    if("spectral_ratio" %in% names(ndvi_with_nlcd)) {
      cat("\n### Spectral Ratio Statistics by Site and NLCD Class\n")
      
      spectral_ratio_by_site_nlcd <- ndvi_with_nlcd %>%
        filter(!is.na(nlcdClass) & !is.na(spectral_ratio)) %>%
        group_by(siteID, nlcdClass) %>%
        summarise(
          n_samples = n(),
          mean_ratio = mean(spectral_ratio, na.rm = TRUE),
          median_ratio = median(spectral_ratio, na.rm = TRUE),
          min_ratio = min(spectral_ratio, na.rm = TRUE),
          max_ratio = max(spectral_ratio, na.rm = TRUE),
          sd_ratio = sd(spectral_ratio, na.rm = TRUE),
          .groups = "drop"
        ) %>%
        arrange(siteID, desc(n_samples))
      
      kable(spectral_ratio_by_site_nlcd, 
            col.names = c("Site ID", "NLCD Class", "N Samples", "Mean Ratio", "Median Ratio", "Min Ratio", "Max Ratio", "SD Ratio"),
            caption = "Spectral Ratio Statistics by Site and NLCD Land Cover Class",
            digits = 4) %>%
        kable_styling(bootstrap_options = c("striped", "hover"), 
                      full_width = TRUE,
                      position = "left") %>%
        row_spec(0, bold = TRUE, color = "white", background = "#FF8C00") %>%
        scroll_box(width = "100%", height = "600px")
    }
    
  } else {
    cat("No NLCD classification data available in sample metadata.\n")
  }
}
```

## Additional Visualizations

```{r additional_visualizations, echo=FALSE, fig.height=8}
if(nrow(ndvi_results) > 0 && exists("fsp_sampleMetadata")) {
  # Join with sample metadata to get NLCD information
  ndvi_with_nlcd <- ndvi_results %>%
    left_join(fsp_sampleMetadata %>% select(spectralSampleID, nlcdClass),
              by = "spectralSampleID")
  
  if("nlcdClass" %in% names(ndvi_with_nlcd) && sum(!is.na(ndvi_with_nlcd$nlcdClass)) > 0) {
    # NDVI by Site and NLCD Class (Faceted Plot)
    site_nlcd_counts <- ndvi_with_nlcd %>%
      filter(!is.na(nlcdClass)) %>%
      group_by(siteID, nlcdClass) %>%
      summarise(n = n(), .groups = "drop") %>%
      group_by(siteID) %>%
      summarise(nlcd_classes = n(), .groups = "drop") %>%
      filter(nlcd_classes > 1)
    
    if(nrow(site_nlcd_counts) > 0) {
      p5 <- ggplot(ndvi_with_nlcd %>% 
                     filter(siteID %in% site_nlcd_counts$siteID & !is.na(nlcdClass)), 
                   aes(x = nlcdClass, y = ndvi, fill = nlcdClass)) +
        geom_boxplot(alpha = 0.7) +
        facet_wrap(~siteID, scales = "free_x", ncol = 3) +
        labs(title = "NDVI Distribution by Site and NLCD Land Cover Class",
             x = "NLCD Class", y = "NDVI") +
        theme_minimal() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1),
              plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
              legend.position = "bottom")
      
      print(p5)
    } else {
      cat("No sites found with multiple NLCD classes for faceted visualization.\n")
    }
    
    # Spectral Ratio by Site and NLCD Class (Faceted Plot)
    if("spectral_ratio" %in% names(ndvi_with_nlcd)) {
      spectral_site_nlcd_counts <- ndvi_with_nlcd %>%
        filter(!is.na(nlcdClass) & !is.na(spectral_ratio)) %>%
        group_by(siteID, nlcdClass) %>%
        summarise(n = n(), .groups = "drop") %>%
        group_by(siteID) %>%
        summarise(nlcd_classes = n(), .groups = "drop") %>%
        filter(nlcd_classes > 1)
      
      if(nrow(spectral_site_nlcd_counts) > 0) {
        p6 <- ggplot(ndvi_with_nlcd %>% 
                       filter(siteID %in% spectral_site_nlcd_counts$siteID & 
                              !is.na(nlcdClass) & !is.na(spectral_ratio)), 
                     aes(x = nlcdClass, y = spectral_ratio, fill = nlcdClass)) +
          geom_boxplot(alpha = 0.7) +
          geom_hline(yintercept = 1, color = "red", linetype = "dashed", size = 0.5) +
          facet_wrap(~siteID, scales = "free_x", ncol = 3) +
          labs(title = "Spectral Ratio Distribution by Site and NLCD Land Cover Class",
               x = "NLCD Class", y = "Spectral Ratio (995-1005/495-505)") +
          theme_minimal() +
          theme(axis.text.x = element_text(angle = 45, hjust = 1),
                plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
                legend.position = "bottom")
        
        print(p6)
      } else {
        cat("No sites found with multiple NLCD classes for spectral ratio faceted visualization.\n")
      }
    }
  }
}
```

## Sigma Analysis and Outlier Detection

```{r sigma_analysis, echo=FALSE}
if(nrow(ndvi_results) > 0) {
  # Function to calculate sigma thresholds and identify outliers - simplified approach
  calculate_sigma_thresholds_simple <- function(data, value_col, group_cols = NULL) {
    if(is.null(group_cols)) {
      # Overall statistics
      mean_val <- mean(data[[value_col]], na.rm = TRUE)
      sd_val <- sd(data[[value_col]], na.rm = TRUE)
      
      thresholds <- data.frame(
        level = c("1_sigma", "2_sigma", "3_sigma"),
        lower = c(mean_val - 1*sd_val, mean_val - 2*sd_val, mean_val - 3*sd_val),
        upper = c(mean_val + 1*sd_val, mean_val + 2*sd_val, mean_val + 3*sd_val)
      )
      
      outliers_3sigma <- data %>%
        filter(!is.na(!!sym(value_col))) %>%
        filter(!!sym(value_col) < (mean_val - 3*sd_val) | !!sym(value_col) > (mean_val + 3*sd_val)) %>%
        select(spectralSampleID, siteID, !!sym(value_col))
      
    } else {
      # Grouped statistics - simplified approach
      group_stats <- data %>%
        filter(!is.na(!!sym(value_col))) %>%
        group_by(across(all_of(group_cols))) %>%
        summarise(
          mean_val = mean(!!sym(value_col), na.rm = TRUE),
          sd_val = sd(!!sym(value_col), na.rm = TRUE),
          n_samples = n(),
          .groups = "drop"
        ) %>%
        filter(!is.na(sd_val) & sd_val > 0)
      
      # Create thresholds data frame directly
      thresholds <- data.frame()
      for(i in 1:nrow(group_stats)) {
        group_row <- group_stats[i,]
        group_key <- paste(group_row[group_cols], collapse = "_")
        
        group_thresholds <- data.frame(
          group = group_key,
          level = c("1_sigma", "2_sigma", "3_sigma"),
          lower = c(group_row$mean_val - 1*group_row$sd_val, 
                   group_row$mean_val - 2*group_row$sd_val, 
                   group_row$mean_val - 3*group_row$sd_val),
          upper = c(group_row$mean_val + 1*group_row$sd_val, 
                   group_row$mean_val + 2*group_row$sd_val, 
                   group_row$mean_val + 3*group_row$sd_val)
        )
        thresholds <- rbind(thresholds, group_thresholds)
      }
      
      # Find outliers for each group
      outliers_3sigma <- data.frame()
      for(i in 1:nrow(group_stats)) {
        group_row <- group_stats[i,]
        
        group_data <- data %>%
          filter(!is.na(!!sym(value_col))) %>%
          filter(across(all_of(group_cols), ~.x == group_row[[cur_column()]]))
        
        group_outliers <- group_data %>%
          filter(!!sym(value_col) < (group_row$mean_val - 3*group_row$sd_val) | 
                 !!sym(value_col) > (group_row$mean_val + 3*group_row$sd_val)) %>%
          select(spectralSampleID, siteID, !!sym(value_col), all_of(group_cols))
        
        if(nrow(group_outliers) > 0) {
          outliers_3sigma <- rbind(outliers_3sigma, group_outliers)
        }
      }
    }
    
    return(list(thresholds = thresholds, outliers_3sigma = outliers_3sigma))
  }
  
  # Function to identify boxplot outliers - simplified approach
  identify_boxplot_outliers_simple <- function(data, value_col, group_cols = NULL) {
    if(is.null(group_cols)) {
      # Overall boxplot outliers
      q1 <- quantile(data[[value_col]], 0.25, na.rm = TRUE)
      q3 <- quantile(data[[value_col]], 0.75, na.rm = TRUE)
      iqr <- q3 - q1
      
      outliers <- data %>%
        filter(!is.na(!!sym(value_col))) %>%
        filter(!!sym(value_col) < (q1 - 1.5*iqr) | !!sym(value_col) > (q3 + 1.5*iqr)) %>%
        select(spectralSampleID, siteID, !!sym(value_col))
      
    } else {
      # Grouped boxplot outliers - simplified approach
      group_stats <- data %>%
        filter(!is.na(!!sym(value_col))) %>%
        group_by(across(all_of(group_cols))) %>%
        summarise(
          q1 = quantile(!!sym(value_col), 0.25, na.rm = TRUE),
          q3 = quantile(!!sym(value_col), 0.75, na.rm = TRUE),
          iqr = q3 - q1,
          n_samples = n(),
          .groups = "drop"
        ) %>%
        filter(!is.na(iqr) & iqr > 0)
      
      outliers <- data.frame()
      for(i in 1:nrow(group_stats)) {
        group_row <- group_stats[i,]
        
        group_data <- data %>%
          filter(!is.na(!!sym(value_col))) %>%
          filter(across(all_of(group_cols), ~.x == group_row[[cur_column()]]))
        
        group_outliers <- group_data %>%
          filter(!!sym(value_col) < (group_row$q1 - 1.5*group_row$iqr) | 
                 !!sym(value_col) > (group_row$q3 + 1.5*group_row$iqr)) %>%
          select(spectralSampleID, siteID, !!sym(value_col), all_of(group_cols))
        
        if(nrow(group_outliers) > 0) {
          outliers <- rbind(outliers, group_outliers)
        }
      }
    }
    
    return(outliers)
  }
  
  # NDVI Analysis by Site
  cat("### NDVI Sigma Thresholds by Site\n")
  ndvi_site_sigma <- calculate_sigma_thresholds_simple(ndvi_results, "ndvi", "siteID")
  
  # Display sigma thresholds for sites
  site_thresholds_display <- ndvi_site_sigma$thresholds %>%
    separate(group, into = c("siteID"), sep = "_") %>%
    pivot_wider(names_from = level, values_from = c(lower, upper)) %>%
    select(siteID, 
           `1_sigma_lower` = lower_1_sigma, `1_sigma_upper` = upper_1_sigma,
           `2_sigma_lower` = lower_2_sigma, `2_sigma_upper` = upper_2_sigma,
           `3_sigma_lower` = lower_3_sigma, `3_sigma_upper` = upper_3_sigma)
  
  kable(site_thresholds_display, digits = 4,
        caption = "NDVI Sigma Thresholds by Site") %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
  
  # NDVI 3-sigma outliers by site
  if(nrow(ndvi_site_sigma$outliers_3sigma) > 0) {
    cat("\n### NDVI 3-Sigma Outliers by Site\n")
    kable(ndvi_site_sigma$outliers_3sigma, digits = 4,
          caption = "NDVI Values Outside 3-Sigma Range by Site") %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
  } else {
    cat("\n### NDVI 3-Sigma Outliers by Site\n")
    cat("No NDVI values outside 3-sigma range for any site.\n")
  }
  
  # Spectral Ratio Analysis by Site
  if("spectral_ratio" %in% names(ndvi_results)) {
    cat("\n### Spectral Ratio Sigma Thresholds by Site\n")
    spectral_site_sigma <- calculate_sigma_thresholds_simple(ndvi_results %>% filter(!is.na(spectral_ratio)), 
                                                     "spectral_ratio", "siteID")
    
    # Display sigma thresholds for spectral ratios by site
    spectral_site_thresholds_display <- spectral_site_sigma$thresholds %>%
      separate(group, into = c("siteID"), sep = "_") %>%
      pivot_wider(names_from = level, values_from = c(lower, upper)) %>%
      select(siteID, 
             `1_sigma_lower` = lower_1_sigma, `1_sigma_upper` = upper_1_sigma,
             `2_sigma_lower` = lower_2_sigma, `2_sigma_upper` = upper_2_sigma,
             `3_sigma_lower` = lower_3_sigma, `3_sigma_upper` = upper_3_sigma)
    
    kable(spectral_site_thresholds_display, digits = 4,
          caption = "Spectral Ratio Sigma Thresholds by Site") %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
    
    # Spectral ratio 3-sigma outliers by site
    if(nrow(spectral_site_sigma$outliers_3sigma) > 0) {
      cat("\n### Spectral Ratio 3-Sigma Outliers by Site\n")
      kable(spectral_site_sigma$outliers_3sigma, digits = 4,
            caption = "Spectral Ratio Values Outside 3-Sigma Range by Site") %>%
        kable_styling(bootstrap_options = c("striped", "hover"))
    } else {
      cat("\n### Spectral Ratio 3-Sigma Outliers by Site\n")
      cat("No spectral ratio values outside 3-sigma range for any site.\n")
    }
  }
  
  # NLCD Analysis (if available)
  if(exists("fsp_sampleMetadata")) {
    ndvi_with_nlcd <- ndvi_results %>%
      left_join(fsp_sampleMetadata %>% select(spectralSampleID, nlcdClass),
                by = "spectralSampleID")
    
    if("nlcdClass" %in% names(ndvi_with_nlcd) && sum(!is.na(ndvi_with_nlcd$nlcdClass)) > 0) {
      cat("\n### NDVI Sigma Thresholds by Site and NLCD Class\n")
      ndvi_nlcd_sigma <- calculate_sigma_thresholds_simple(ndvi_with_nlcd %>% filter(!is.na(nlcdClass)), 
                                                   "ndvi", c("siteID", "nlcdClass"))
      
      # Display sigma thresholds for NLCD groups
      nlcd_thresholds_display <- ndvi_nlcd_sigma$thresholds %>%
        separate(group, into = c("siteID", "nlcdClass"), sep = "_") %>%
        pivot_wider(names_from = level, values_from = c(lower, upper)) %>%
        select(siteID, nlcdClass,
               `1_sigma_lower` = lower_1_sigma, `1_sigma_upper` = upper_1_sigma,
               `2_sigma_lower` = lower_2_sigma, `2_sigma_upper` = upper_2_sigma,
               `3_sigma_lower` = lower_3_sigma, `3_sigma_upper` = upper_3_sigma)
      
      kable(nlcd_thresholds_display, digits = 4,
            caption = "NDVI Sigma Thresholds by Site and NLCD Class") %>%
        kable_styling(bootstrap_options = c("striped", "hover"))
      
      # NDVI 3-sigma outliers by NLCD
      if(nrow(ndvi_nlcd_sigma$outliers_3sigma) > 0) {
        cat("\n### NDVI 3-Sigma Outliers by Site and NLCD Class\n")
        kable(ndvi_nlcd_sigma$outliers_3sigma, digits = 4,
              caption = "NDVI Values Outside 3-Sigma Range by Site and NLCD Class") %>%
          kable_styling(bootstrap_options = c("striped", "hover"))
      } else {
        cat("\n### NDVI 3-Sigma Outliers by Site and NLCD Class\n")
        cat("No NDVI values outside 3-sigma range for any site-NLCD combination.\n")
      }
      
      # Spectral Ratio NLCD Analysis
      if("spectral_ratio" %in% names(ndvi_with_nlcd)) {
        cat("\n### Spectral Ratio Sigma Thresholds by Site and NLCD Class\n")
        spectral_nlcd_sigma <- calculate_sigma_thresholds_simple(
          ndvi_with_nlcd %>% filter(!is.na(nlcdClass) & !is.na(spectral_ratio)), 
          "spectral_ratio", c("siteID", "nlcdClass"))
        
        # Display sigma thresholds for spectral ratios by NLCD
        spectral_nlcd_thresholds_display <- spectral_nlcd_sigma$thresholds %>%
          separate(group, into = c("siteID", "nlcdClass"), sep = "_") %>%
          pivot_wider(names_from = level, values_from = c(lower, upper)) %>%
          select(siteID, nlcdClass,
                 `1_sigma_lower` = lower_1_sigma, `1_sigma_upper` = upper_1_sigma,
                 `2_sigma_lower` = lower_2_sigma, `2_sigma_upper` = upper_2_sigma,
                 `3_sigma_lower` = lower_3_sigma, `3_sigma_upper` = upper_3_sigma)
        
        kable(spectral_nlcd_thresholds_display, digits = 4,
              caption = "Spectral Ratio Sigma Thresholds by Site and NLCD Class") %>%
          kable_styling(bootstrap_options = c("striped", "hover"))
        
        # Spectral ratio 3-sigma outliers by NLCD
        if(nrow(spectral_nlcd_sigma$outliers_3sigma) > 0) {
          cat("\n### Spectral Ratio 3-Sigma Outliers by Site and NLCD Class\n")
          kable(spectral_nlcd_sigma$outliers_3sigma, digits = 4,
                caption = "Spectral Ratio Values Outside 3-Sigma Range by Site and NLCD Class") %>%
            kable_styling(bootstrap_options = c("striped", "hover"))
        } else {
          cat("\n### Spectral Ratio 3-Sigma Outliers by Site and NLCD Class\n")
          cat("No spectral ratio values outside 3-sigma range for any site-NLCD combination.\n")
        }
      }
    }
  }
  
  # Boxplot Outlier Analysis
  cat("\n### Boxplot Outlier Analysis\n")
  
  # Overall boxplot outliers
  ndvi_boxplot_outliers <- identify_boxplot_outliers_simple(ndvi_results, "ndvi")
  if(nrow(ndvi_boxplot_outliers) > 0) {
    cat("\n#### NDVI Boxplot Outliers (Overall)\n")
    kable(ndvi_boxplot_outliers, digits = 4,
          caption = "NDVI Values Outside Boxplot Range (1.5 * IQR)") %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
  } else {
    cat("\n#### NDVI Boxplot Outliers (Overall)\n")
    cat("No NDVI values outside boxplot range.\n")
  }
  
  # NDVI boxplot outliers by site
  ndvi_site_boxplot_outliers <- identify_boxplot_outliers_simple(ndvi_results, "ndvi", "siteID")
  if(nrow(ndvi_site_boxplot_outliers) > 0) {
    cat("\n#### NDVI Boxplot Outliers by Site\n")
    kable(ndvi_site_boxplot_outliers, digits = 4,
          caption = "NDVI Values Outside Boxplot Range by Site") %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
  } else {
    cat("\n#### NDVI Boxplot Outliers by Site\n")
    cat("No NDVI values outside boxplot range for any site.\n")
  }
  
  # Spectral ratio boxplot outliers
  if("spectral_ratio" %in% names(ndvi_results)) {
    spectral_boxplot_outliers <- identify_boxplot_outliers_simple(ndvi_results %>% filter(!is.na(spectral_ratio)), 
                                                          "spectral_ratio")
    if(nrow(spectral_boxplot_outliers) > 0) {
      cat("\n#### Spectral Ratio Boxplot Outliers (Overall)\n")
      kable(spectral_boxplot_outliers, digits = 4,
            caption = "Spectral Ratio Values Outside Boxplot Range (1.5 * IQR)") %>%
        kable_styling(bootstrap_options = c("striped", "hover"))
    } else {
      cat("\n#### Spectral Ratio Boxplot Outliers (Overall)\n")
      cat("No spectral ratio values outside boxplot range.\n")
    }
    
    # Spectral ratio boxplot outliers by site
    spectral_site_boxplot_outliers <- identify_boxplot_outliers_simple(
      ndvi_results %>% filter(!is.na(spectral_ratio)), "spectral_ratio", "siteID")
    if(nrow(spectral_site_boxplot_outliers) > 0) {
      cat("\n#### Spectral Ratio Boxplot Outliers by Site\n")
      kable(spectral_site_boxplot_outliers, digits = 4,
            caption = "Spectral Ratio Values Outside Boxplot Range by Site") %>%
        kable_styling(bootstrap_options = c("striped", "hover"))
    } else {
      cat("\n#### Spectral Ratio Boxplot Outliers by Site\n")
      cat("No spectral ratio values outside boxplot range for any site.\n")
    }
  }
}
```

## Error Summary

```{r error_summary, echo=FALSE, results='asis'}
if(nrow(download_errors) > 0) {
  error_summary <- download_errors %>%
    group_by(error) %>%
    summarise(count = n(), .groups = "drop") %>%
    arrange(desc(count))
  
  kable(error_summary, 
        col.names = c("Error Type", "Count"),
        caption = "Download Error Summary") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), 
                  full_width = FALSE,
                  position = "left") %>%
    row_spec(0, bold = TRUE, color = "white", background = "#D7261E")
} else {
  cat("No download errors encountered during processing.")
}
```

## Session Information

```{r session_info, echo=FALSE}
sessionInfo()
```

## Conclusion

This analysis provides a comprehensive overview of NDVI and spectral ratio calculations from NEON FSP data collected between 2019-2024, including NLCD-based ecological context. The results show:

- **Data Quality**: `r if(nrow(ndvi_results) > 0) round(nrow(ndvi_results)/nrow(ndvi_results) * 100, 1) else 0`% success rate in processing spectral samples
- **NDVI Range**: Values ranging from `r if(nrow(ndvi_results) > 0) round(min(ndvi_results$ndvi, na.rm = TRUE), 4) else "N/A"` to `r if(nrow(ndvi_results) > 0) round(max(ndvi_results$ndvi, na.rm = TRUE), 4) else "N/A"`
- **Spectral Ratios**: `r if(nrow(ndvi_results) > 0 && "spectral_ratio" %in% names(ndvi_results)) round(sum(ndvi_results$spectral_ratio > 1, na.rm = TRUE)/sum(!is.na(ndvi_results$spectral_ratio)) * 100, 1) else "N/A"`% of samples show expected spectral ratio patterns
- **Spatial Coverage**: Data from `r if(nrow(ndvi_results) > 0) length(unique(ndvi_results$siteID)) else 0` NEON sites
- **Temporal Coverage**: Data spanning `r if(nrow(ndvi_results) > 0) length(unique(substr(ndvi_results$collectDate, 1, 4))) else 0` years
- **Ecological Context**: Analysis across `r if(exists("ndvi_with_nlcd") && "nlcdClass" %in% names(ndvi_with_nlcd)) length(unique(ndvi_with_nlcd$nlcdClass[!is.na(ndvi_with_nlcd$nlcdClass)])) else 0` NLCD land cover classes

The analysis reveals spatial and temporal patterns in vegetation health and spectral characteristics across the NEON network, with ecological context provided by NLCD land cover classifications. This information can be used to inform quality assessment decisions and threshold development for different vegetation types and ecosystems.

### Key Findings:

1. **Site-Specific Patterns**: Different NEON sites show distinct NDVI and spectral ratio characteristics
2. **NLCD-Based Variation**: Land cover types exhibit different spectral signatures and patterns
3. **Data Coverage**: The analysis demonstrates the spatial and temporal coverage of NEON FSP data
4. **Spectral Characteristics**: The data provides baseline information for understanding spectral properties across different ecosystems

This comprehensive approach to spectral analysis provides valuable insights for ecological research and monitoring, with information that can be used to develop appropriate quality assessment criteria for different ecosystems and land cover types.